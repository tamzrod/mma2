# ============================================================
# MMA 2.0 – Canonical Example Configuration
# Demonstrates:
# - Multiple listeners (ports)
# - Multiple Unit IDs per port
# - Access control (RO / RW / WO)
# - State sealing (on selected units only)
#
# Runtime identity remains: (Port, UnitID)
# ============================================================

listeners:
  # ------------------------------------------------------------
  # Listener on standard Modbus TCP port 502
  # ------------------------------------------------------------
  - id: main-modbus
    listen: ":502"

    memory:
      # ========================================================
      # UNIT ID 1 — OPEN DEVICE (Beginner-friendly)
      # ========================================================
      # Purpose:
      # - First-time users
      # - Inverters / meters
      # - "It just works" example
      #
      # Behavior:
      # - Any IP
      # - All Modbus function codes allowed
      # - NO state sealing
      # ========================================================
      - name: inverter_open
        unit_id: 1

        coils:
          start: 0
          count: 128

        holding_registers:
          start: 0
          count: 256

        policy:
          rules:
            - id: allow-all
              source_ip:
                - 0.0.0.0/0      # all IPv4
                - ::/0           # all IPv6
                - 127.0.0.1     # localhost
                - ::1           # localhost IPv6
              allow_fc: [1,2,3,4,5,6,15,16]       # rw == full Modbus access

      # ========================================================
      # UNIT ID 2 — CONTROLLED DEVICE (Advanced)
      # ========================================================
      # Purpose:
      # - Setpoints
      # - PPC / EMS interfaces
      #
      # Behavior:
      # - Read-only for LAN
      # - Write-only for localhost / controller
      # - State sealing enabled
      # ========================================================
      - name: ppc_control
        unit_id: 2

        # --------------------
        # STATE SEALING
        # --------------------
        # Default: sealed (flag = 0)
        # Unseal by writing 1 to coil 0 via RAW INGEST
        state_sealing:
          area: coil
          address: 0

        coils:
          start: 0
          count: 16

        holding_registers:
          start: 0
          count: 64

        policy:
          rules:
            # Local controller — full control
            - id: controller-rw
              source_ip:
                - 127.0.0.1
                - ::1
              allow_fc: [1,2,3,4,5,6,15,16]

            # Plant LAN — read-only
            - id: lan-read
              source_ip:
                - 192.168.2.0/24
              allow: ro

  # ------------------------------------------------------------
  # Second listener on port 503 (example: test / lab network)
  # ------------------------------------------------------------
  - id: lab-modbus
    listen: ":504"

    memory:
      # ========================================================
      # UNIT ID 1 — LAB DEVICE
      # ========================================================
      - name: lab_meter
        unit_id: 1

        holding_registers:
          start: 0
          count: 32

        policy:
          rules:
            - id: lab-read
              source_ip:
                - 10.10.0.0/16
              allow: ro
